(function($){"use strict";redux.field_objects=redux.field_objects||{};redux.field_objects.multi_media=redux.field_objects.multi_media||{};redux.field_objects.multi_media.mainID="";var l10n;var frame;redux.field_objects.multi_media.init=function(selector){if(!selector){selector=$(document).find(".redux-multi-media-container")}$(selector).each(function(){var el=$(this);var parent=el;if(!el.hasClass("redux-field-container")){parent=el.closest(".redux-field-container")}if(parent.hasClass("redux-field-init")){parent.removeClass("redux-field-init")}else{return}el.unbind("click",".redux_remove_file_button").on("click",".redux_remove_file_button",function(event){redux.field_objects.multi_media.removeFile(event,$(this).closest("fieldset.redux-field"),$(this))});el.find(".redux_upload_button").unbind("click").on("click",function(event){redux.field_objects.multi_media.addFile(event,$(this).closest("fieldset.redux-field"),$(this))});redux.field_objects.multi_media.modInit(el)})};redux.field_objects.multi_media.modInit=function(el){l10n=redux_multi_media_l10;redux.field_objects.multi_media.mainID=el.attr("data-id");var dev_mode=Boolean(el.find(".redux-multi-media-container").data("dev-mode"));if(dev_mode===true){var ver=el.find(".redux-multi-media-container").data("version");var dev_html=$("div.redux-timer").html();if(dev_html!==undefined){var pos=dev_html.indexOf("Multi Media Selector");if(pos===-1){$("div.redux-timer").html(dev_html+"<br/>Multi Media Selector extension v."+ver)}}}};redux.field_objects.multi_media.removeErrMsgs=function(){$(".redux-container-multi_media .attach_list li.redux-file-exists").each(function(idx,li){$(li).remove()});$(".redux-container-multi_media .attach_list li.redux-max-limit").each(function(idx,li){$(li).remove()})};redux.field_objects.multi_media.selExists=function(item,selector){var val=false;$(selector).find(".attach_list li").each(function(idx,li){var len=$(li).find("input#filelist-"+item);if(len.length!==0){val=true}});return val};redux.field_objects.multi_media.addFile=function(event,selector,self){event.preventDefault();var libFilter;var isList=true;var uploadStatus=true;var inputID=self.prev("input").attr("id");var $formfield=$("#"+inputID);console.log(inputID);var formName=$formfield.attr("name");redux.field_objects.multi_media.removeErrMsgs();var filter=$(selector).find(".library-filter").data("lib-filter");var maxFileUpload=$(selector).find(".redux-multi-media-container").data("max-file-upload");if(filter!==undefined){if(filter!==""){libFilter=[];filter=decodeURIComponent(filter);filter=JSON.parse(filter);$.each(filter,function(index,value){libFilter.push(value)})}}frame=wp.media({multiple:isList?true:false,title:l10n.title,library:{type:libFilter},button:{text:l10n.upload_file}});var doChange;frame.on("select",function(){var addCount=0;var selection=frame.state().get("selection");var attachment=selection.toJSON();$formfield.val(attachment.url);$("#"+inputID+"_id").val(attachment.id);var fileGroup=[];var fileArr=[];var imgArr=[];var msgArr=[];var childCount=$(selector).find(".attach_list").children().length;$(attachment).each(function(){if(maxFileUpload<=0||addCount+childCount<maxFileUpload){if(redux.field_objects.multi_media.selExists(this.id,selector)){var dupMsg=l10n.dup_warn;dupMsg=dupMsg.replace("%s","<strong>"+this.filename+"</strong>");uploadStatus='<li class="redux-file-exists">'+dupMsg+"</li>";msgArr.push(uploadStatus);doChange=false;return true}if(this.type&&this.type==="image"){uploadStatus='<li class="img_status">'+'<img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'">'+'<p><a href="#" class="redux_remove_file_button" rel="'+inputID+"["+this.id+']">'+l10n.remove_image+"</a></p>"+'<input type="hidden" id="filelist-'+this.id+'" name="'+formName+"["+this.id+']" value="'+this.url+'">'+"</li>";imgArr.push(uploadStatus);doChange=true}else{uploadStatus="<li>"+l10n.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+l10n.download+'</a> / <a href="#" class="redux_remove_file_button" rel="'+inputID+"["+this.id+']">'+l10n.remove_file+"</a>)"+'<input type="hidden" id="filelist-'+this.id+'" name="'+formName+"["+this.id+']" value="'+this.url+'">'+"</li>";fileArr.push(uploadStatus)}addCount++}else{var maxMsg=l10n.max_warn;maxMsg=maxMsg.replace("%s","<strong>"+maxFileUpload+"</strong>");uploadStatus='<li class="redux-max-limit">'+maxMsg+"</li>";msgArr.push(uploadStatus)}});if(!$.isEmptyObject(imgArr)){$(imgArr).each(function(idx,val){fileGroup.push(val);doChange=true})}if(!$.isEmptyObject(fileArr)){$(fileArr).each(function(idx,val){fileGroup.push(val);doChange=true})}if(!$.isEmptyObject(msgArr)){$(msgArr).each(function(idx,val){fileGroup.push(val)})}$(fileGroup).each(function(){$formfield.siblings(".redux_media_status").slideDown().append(this)});frame.close();if(doChange===true){redux_change($(selector).find(".redux_media_status"))}});frame.open()};redux.field_objects.multi_media.removeFile=function(event,selector,self){event.preventDefault();var $self=self;if($self.is(".attach_list .redux_remove_file_button")){$self.parents("li").remove();redux_change($(selector).find(".redux_media_status"));return false}var inputID=$self.attr("rel");var $container=$self.parents(".img_status");selector.find("input#"+inputID).val("");selector.find("input#"+inputID+"_id").val("");if(!$container.length){$self.parents(".redux_media_status").html("")}else{$container.html("")}return false}})(jQuery);