(function($){"use strict";redux.field_objects=redux.field_objects||{};var reduxObject;if(!redux.field_objects.serialized_repeater){redux.field_objects.serialized_repeater={animationDuration:350,dragAndDropInProgress:false,isIE9:/MSIE 9/i.test(navigator.userAgent)}}redux.field_objects.serialized_repeater.init=function(selector,initHidden){if(!initHidden){initHidden=false}if(!selector){selector=$(document).find(".redux-group-tab:visible .redux-field-init.redux-container-serialized_repeater:visible")}selector.each(function(index){var $this=$(this);if(!$this.hasClass("redux-field-container")){$this=$this.parents(".redux-field-container:first");if(!$this){return}}var optName=$this.parents(".redux-container").data("opt-name");if(optName===undefined){reduxObject=redux}else{reduxObject=redux.optName}if(!initHidden&&$this.is(":hidden")){return}if($this.hasClass("redux-field-init")){$this.removeClass("redux-field-init");if(redux.field_objects.serialized_repeater.isIE9){$this.addClass("redux-field-old-ie")}}else{return}redux.field_objects.serialized_repeater.updateInteractionHandlers($this.find("> .redux-serialized-repeater-row-container"));$this.on("click","a.redux-serialized-repeater-add",redux.field_objects.serialized_repeater.onAddClick);$this.on("click","a.redux-serialized-repeater-delete",redux.field_objects.serialized_repeater.onDeleteClick)})};redux.field_objects.serialized_repeater.onBoundTitleValueChange=function(event){function appendBindTitle(newTitle){if(titleLength>=maxTitleLength-prefix.length-postfix.length){return false}title.push(newTitle);titleLength+=newTitle.length+separator.length;return true}var $field=$(event.target);var $fieldContainer=$field.closest("fieldset.redux-field-container");var $addButton=$fieldContainer.closest(".redux-container-serialized_repeater").find(".redux-serialized-repeater-add");var separator=$addButton.attr("data-bindtitleseparator");var prefix=$addButton.attr("data-bindtitleprefix");var postfix=$addButton.attr("data-bindtitlepostfix");var title=[];var titleLength=0;var maxTitleLength=Number($addButton.attr("data-bindtitlelimit"));switch($fieldContainer.attr("data-type")){case"radio":case"checkbox":$field.closest("ul").find("label input:checked").each(function(){return appendBindTitle($(this).parent().text())});break;case"button_set":$fieldContainer.find("input:checked + label > span").each(function(){return appendBindTitle($(this).text())});break;case"image_select":$field.closest("ul").find("label input:checked").each(function(){return appendBindTitle($(this).parent().find("img").attr("alt"))});break;case"sortable":if($field.prop("type")=="text"){$field.closest("ul").find("input").each(function(){return appendBindTitle($(this).val())})}else{$field.closest("ul").find("input:checked").each(function(){return appendBindTitle($(this).parent().text())})}break;case"password":if($field.attr("type")=="text"){title.push($field.val())}else{return}break;case"select":case"select_image":$field.find("option:selected").each(function(){return appendBindTitle($(this).text())});break;case"slider":var $selectedOptions=$fieldContainer.find("select option:selected");if($selectedOptions.length){$selectedOptions.each(function(){return appendBindTitle($(this).val())})}else{$fieldContainer.find("input:hidden").each(function(){return appendBindTitle($(this).val())})}break;case"switch":$fieldContainer.find("label.selected span").each(function(){return appendBindTitle($(this).text())});break;case"option_slider":$fieldContainer.find(".redux-option-slider-label").each(function(){return appendBindTitle($(this).text())});break;case"palette":$fieldContainer.find("input:checked").each(function(){return appendBindTitle($(this).val())});break;case"textarea":title.push($field.val());break;case"dimensions":case"spacing":case"typography":$fieldContainer.find('input[type="hidden"],select:hidden > option:selected').each(function(){var $thisField=$(this);if(!($thisField.hasClass("field-units")||$thisField.hasClass("redux-font-clear")||$thisField.hasClass("redux-typography-google")||$thisField.hasClass("redux-typography-google-font"))){if($thisField.prop("tagName")=="OPTION"){return appendBindTitle($(this).text())}else{return appendBindTitle($(this).val())}}});break;case"color":if($field.prop("checked")){title.push($field.parent().text())}else{title.push($fieldContainer.find("input.redux-color").val())}break;case"ace_editor":title.push($field.closest(".ace-wrapper").find("> textarea.ace-editor").val());break;case"ckeditor":break;default:$field.closest("fieldset").find('input[type!="hidden"],textarea').each(function(){return appendBindTitle($(this).val())});break}if(title.constructor===Array){title=title.filter(function(e){return e});title=title.join(separator)}if(title){title=prefix+redux.field_objects.serialized_repeater.trim(title,maxTitleLength,$addButton.attr("data-bindtitlemore"))+postfix;$field.closest(".redux-serialized-repeater-row").find("> h3 .title").text(title)}else{$field.closest(".redux-serialized-repeater-row").find("> h3 .title").html("&nbsp;")}return false};redux.field_objects.serialized_repeater.trim=function(string,length,more){if(string.length>length-more.length){return string.substr(0,length-more.length)+more}return string};redux.field_objects.serialized_repeater.updateInteractionHandlers=function($rowContainer){var $accordionRows=$rowContainer.find("> .redux-serialized-repeater-row:not(.ui-accordion)");if($accordionRows.length){var $addButton=$rowContainer.parent().find("> .redux-serialized-repeater-add");var style=$addButton.attr("data-accordionstyle");var state=$addButton.attr("data-accordionstate");var targetFieldActive=false;redux.field_objects.serialized_repeater.forceAccordionPaneClosing=false;$accordionRows.each(function(){var active=false;switch(state){case"all":active=0;break;case"first":if(!targetFieldActive){targetFieldActive=true;active=0}break;case"closed":break}$(this).accordion({header:"> h3",collapsible:true,active:active,animate:200,heightStyle:"content",activate:function(event,ui){$.redux.initFields()},beforeActivate:function(event,ui){if(redux.field_objects.serialized_repeater.dragAndDropInProgress){return false}if(redux.field_objects.serialized_repeater.forceAccordionPaneClosing){return true}var $row=$(this);var isActive=$row.accordion("option","active")!==false;var $addButton=$row.closest(".redux-container-serialized_repeater").find("> .redux-serialized-repeater-add");var style=$addButton.attr("data-accordionstyle");var state=$addButton.attr("data-accordionstate");if(style==="single"&&isActive){return false}if(style==="single"||style==="collapsible"){redux.field_objects.serialized_repeater.closeAllAccordionPanes($row.parent(),$row)}}}).removeClass("ui-widget")})}if($rowContainer.hasClass("ui-sortable")){$rowContainer.sortable("refresh")}else{$rowContainer.sortable({start:redux.field_objects.serialized_repeater.onSortableStart,update:redux.field_objects.serialized_repeater.onSortableUpdate,stop:redux.field_objects.serialized_repeater.onSortableStop,placeholder:"sortable-placeholder",handle:"> .sort-handle, > h3 > .sort-handle",revert:120,items:"> .redux-serialized-repeater-row",tolerance:"pointer",distance:3,delay:100,scroll:false})}$rowContainer.find("> .redux-serialized-repeater-row.bind-title").each(function(){$(this).find("> fieldset > fieldset").each(function(){var $this=$(this);if(["text","textarea","password","radio"].indexOf($this.attr("data-type"))!==-1){$this.removeClass("redux-field-init")}if($this.hasClass("bind-title")){redux.field_objects.serialized_repeater.updateBindTitleHandlers($(this))}})})};redux.field_objects.serialized_repeater.updateBindTitleHandlers=function($fieldContainer){if($fieldContainer.hasClass("redux-field-init")){if(!$fieldContainer.attr("data-updateinteractioninterval")){if($fieldContainer.is(":hidden")){redux.field_objects.serialized_repeater.init($fieldContainer,true)}$fieldContainer.attr("data-updateinteractioninterval",setInterval(function(){redux.field_objects.serialized_repeater.updateBindTitleHandlers($fieldContainer)},1e3))}}else{var updateInterval=$fieldContainer.attr("data-updateinteractioninterval");if(updateInterval){clearInterval(updateInterval);$fieldContainer.removeAttr("data-updateinteractioninterval")}var hasHandler=false;var eventHandlers=$._data($fieldContainer.get(0),"events");if(eventHandlers){for(var handler in eventHandlers){if((handler==="change"||handler==="keyup")&&eventHandlers.hasOwnProperty(handler)){if(eventHandlers[handler][0]&&eventHandlers[handler][0].handler===redux.field_objects.serialized_repeater.onBoundTitleValueChange){hasHandler=true;break}}}}if(!hasHandler){$fieldContainer.on("change keyup",redux.field_objects.serialized_repeater.onBoundTitleValueChange);$fieldContainer.find("input:first,textarea:first,select:first").trigger("change")}}};redux.field_objects.serialized_repeater.openAccordionPane=function($row){var isActive=$row.accordion("option","active")!==false;var $addButton=$row.closest(".redux-container-serialized_repeater").find("> .redux-serialized-repeater-add");var style=$addButton.attr("data-accordionstyle");var state=$addButton.attr("data-accordionstate");if(!isActive){$row.accordion("option","active",0)}if(style==="single"||style==="collapsible"){redux.field_objects.serialized_repeater.closeAllAccordionPanes($row.parent(),$row)}};redux.field_objects.serialized_repeater.closeAccordionPane=function($row,forceClose){redux.field_objects.serialized_repeater.forceAccordionPaneClosing=forceClose;$row.accordion("option","active",false);redux.field_objects.serialized_repeater.forceAccordionPaneClosing=false};redux.field_objects.serialized_repeater.closeAllAccordionPanes=function($rowContainer,$rowToKeepOpen){$rowContainer.find("> .redux-serialized-repeater-row").each(function(){var $this=$(this);if(!$this.is($rowToKeepOpen)){redux.field_objects.serialized_repeater.closeAccordionPane($this,true)}else{}})};redux.field_objects.serialized_repeater.onSortableStart=function(event,ui){redux.field_objects.serialized_repeater.dragAndDropInProgress=true;ui.item.parent().addClass("sorting").css("padding-bottom",ui.item.height()+"px");ui.placeholder.append('<div class="content"></div>')};redux.field_objects.serialized_repeater.onSortableUpdate=function(event,ui){var $addButton=ui.item.closest(".redux-container-serialized_repeater").find("> .redux-serialized-repeater-add");var rootId=$addButton.attr("data-rootid");var settingsId=$addButton.attr("data-settingsid");var $rootRepeater=$("#"+settingsId+"-"+rootId);redux.field_objects.serialized_repeater.renumberRows($rootRepeater.find("> .redux-serialized-repeater-row-container"))};redux.field_objects.serialized_repeater.onSortableStop=function(event,ui){redux.field_objects.serialized_repeater.dragAndDropInProgress=false;var $rowContainer=ui.item.parent();$rowContainer.removeClass("sorting size-small size-medium size-large").addClass("sort-stop").css("padding-bottom",0);setTimeout(function($rowContainer){$rowContainer.removeClass("sort-stop")},310,$rowContainer)};redux.field_objects.serialized_repeater.removeNumberedBrackets=function(string){return string.replace(/\[(\d+)\]/g,"")};redux.field_objects.serialized_repeater.getRowToInsert=function($fieldContainer,fieldName){var currentFieldName=$fieldContainer.find("> .redux-serialized-repeater-row-container").attr("data-fieldname");if(fieldName!=currentFieldName){currentFieldName=redux.field_objects.serialized_repeater.removeNumberedBrackets(currentFieldName)}if(fieldName==currentFieldName){var $rows=$fieldContainer.find("> .redux-serialized-repeater-row-container  > .redux-serialized-repeater-row");$rows.find('> fieldset > fieldset[data-type="serialized_repeater"] > .redux-serialized-repeater-row-container > .redux-serialized-repeater-row').remove();return $rows}var subRepeaters=$fieldContainer.find('> .redux-serialized-repeater-row-container > .redux-serialized-repeater-row > fieldset > fieldset[data-type="serialized_repeater"]');for(var i=0,count=subRepeaters.length;i<count;i++){var results=redux.field_objects.serialized_repeater.getRowToInsert($(subRepeaters[i]),fieldName);if(results!==false){return results}}return false};redux.field_objects.serialized_repeater.onAddClick=function(event){event.stopImmediatePropagation();var $this=$(this);var rootId=$this.attr("data-rootid");var settingsId=$this.attr("data-settingsid");var fieldName=$this.attr("data-fieldname");var limit=Number($this.attr("data-limit"));var level=Number($this.attr("data-level"));var count=Number($this.attr("data-count"));var counter=Number($this.attr("data-counter"));var displayType=$this.attr("data-displaytype");if(limit>0&&count>=limit){return false}if(!reduxObject.serialized_repeater[rootId]){return false}var fieldSettings=reduxObject.serialized_repeater[rootId];if(!fieldSettings.htmlDataNewReplacementDone){fieldSettings.htmlDataNewReplacementDone=true;fieldSettings.html=$($.parseHTML(fieldSettings.html)[0]);fieldSettings.html.find(".redux-serialized-repeater-row").attr("data-new","true")}var $rootRepeater=$("#"+settingsId+"-"+rootId);var $newRow=fieldSettings.html.clone();$newRow=redux.field_objects.serialized_repeater.getRowToInsert($newRow,redux.field_objects.serialized_repeater.removeNumberedBrackets(fieldName));var $rowContainer=$this.parent().find("> .redux-serialized-repeater-row-container");$rowContainer.append($newRow);redux.field_objects.serialized_repeater.renumberRows($rootRepeater.find("> .redux-serialized-repeater-row-container"));redux.field_objects.serialized_repeater.updateInteractionHandlers($rowContainer);if(displayType=="accordion"){redux.field_objects.serialized_repeater.openAccordionPane($newRow)}$rowContainer.addClass("animating");$newRow.addClass("initially-created");setTimeout(function(){$newRow.addClass("making-visible")},1);setTimeout(function(){$newRow.removeClass("initially-created making-visible");if($rowContainer.find("> .redux-serialized-repeater-row.initially-created, > .redux-serialized-repeater-row.initially-deleted").length==0){$rowContainer.removeClass("animating")}},redux.field_objects.serialized_repeater.animationDuration+10);$.redux.initFields();if(limit>0&&count>=limit-1){if($this.hasClass("button")){$this.addClass("button-disabled")}$this.attr("data-disabled","true")}return false};redux.field_objects.serialized_repeater.onDeleteClick=function(event){event.stopImmediatePropagation();redux_change($(this));var $this=$(this);if($this.attr("data-disabled")=="true"){return false}var $addButton=$this.closest(".redux-container-serialized_repeater").find("> .redux-serialized-repeater-add");var rootId=$addButton.attr("data-rootid");var settingsId=$addButton.attr("data-settingsid");var limit=Number($addButton.attr("data-limit"));var level=Number($addButton.attr("data-level"));var count=Number($addButton.attr("data-count"));var counter=Number($addButton.attr("data-counter"));var displayType=$addButton.attr("data-displaytype");var $rootRepeater=$("#"+settingsId+"-"+rootId);var $row=$this.closest(".redux-serialized-repeater-row");var $rowContainer=$row.parent();if($this.hasClass("button")){$this.addClass("button-disabled")}$this.attr("data-disabled","true");$addButton.attr("data-count",--count);if(displayType=="accordion"){if($row.siblings().length){var $nextRow=$row.next();if(!$nextRow.length){$nextRow=$row.prev()}setTimeout(function(){redux.field_objects.serialized_repeater.openAccordionPane($nextRow)},redux.field_objects.serialized_repeater.animationDuration/4)}}$rowContainer.addClass("animating");$row.addClass("initially-deleting");$row.find("> fieldset").delay(100).slideUp(redux.field_objects.serialized_repeater.animationDuration);setTimeout(function(){$row.addClass("making-invisible")},1);setTimeout(function(){$row.remove();redux.field_objects.serialized_repeater.renumberRows($rootRepeater.find("> .redux-serialized-repeater-row-container"));if(limit>0&&count<limit){$addButton.removeClass("button-disabled")}if($rowContainer.find("> .redux-serialized-repeater-row.initially-created, > .redux-serialized-repeater-row.initially-deleting").length==0){$rowContainer.removeClass("animating")}},redux.field_objects.serialized_repeater.animationDuration+100);return false};redux.field_objects.serialized_repeater.renumberRows=function($rowContainer){var $addButton=$rowContainer.parent().find("> .redux-serialized-repeater-add");var rootId=$addButton.attr("data-rootid");var settingsId=$addButton.attr("data-settingsid");var limit=Number($addButton.attr("data-limit"));var level=Number($addButton.attr("data-level"));var count=Number($addButton.attr("data-count"));var counter=Number($addButton.attr("data-counter"));var fieldSettings=reduxObject.serialized_repeater[rootId];fieldSettings.level=fieldSettings.level||[];fieldSettings.level[level]={$addButton:$addButton,currentRowNumber:0};$rowContainer.find("> .redux-serialized-repeater-row").each(function(rowNumber){function replaceId(id){var regex=/{{index-(\d+)}}/g;id=id.replace(regex,function(match,p1){var currentLevelCount=fieldSettings.level[p1].$addButton.attr("data-count");var currentLevelCounter=fieldSettings.level[p1].$addButton.attr("data-counter");return currentLevelCounter});return id}var isNewRow=false;var $thisRow=$(this);fieldSettings.level[level].currentRowNumber=rowNumber;if($thisRow.attr("data-new")=="true"){$thisRow.removeAttr("data-new");isNewRow=true;$addButton.attr("data-count",++count);$addButton.attr("data-counter",++counter)}var $inputs=$thisRow.find("input,select,textarea").filter(function(){return $(this).parents(".redux-serialized-repeater-row").length==level+1});$inputs.each(function(index){var $thisInput=$(this);var $thisLevelAddButton=$thisInput.closest(".redux-container-serialized_repeater").find("> .redux-serialized-repeater-add");var fieldType=$thisInput.closest(".redux-field-container").attr("data-type");var name=$thisInput.attr("name");if(name){var nameSuffix="";if(name.substr(-2)=="[]"){nameSuffix="[]"}var regex=/\[([^\]]+)\]/g;var matches=[];var match=regex.exec(name);while(match!=null){matches.push(match[1]);match=regex.exec(name)}var newName=settingsId;var matchLevel=-1;var parentLevel=0;for(var i=0,count=matches.length;i<count;i++){var name=matches[i];if($.isNumeric(matches[i])){if(i+1<matches.length){++matchLevel;if(matchLevel==level){name=rowNumber}else{name=fieldSettings.level[parentLevel++].currentRowNumber}}else{}}newName+="["+name+"]"}newName+=nameSuffix;$thisInput.attr("name",newName);if(fieldType=="multi_text"){var $multiTextAddButton=$thisInput.closest(".redux-field-container").find(".redux-multi-text-add");if($multiTextAddButton.attr("data-name").indexOf("[99999]")!==-1){$multiTextAddButton.attr("data-name",newName)}}}if(isNewRow){var $parentContainer=$thisInput.closest(".redux-field-container");if($parentContainer.prop("id")){$parentContainer.prop("id",replaceId($parentContainer.prop("id")))}if($parentContainer.attr("data-id")){$parentContainer.attr("data-id",replaceId($parentContainer.attr("data-id")))}$parentContainer.find('*[id*="{{index-"],*[for*="{{index-"],*[rel*="{{index-"],*[class*="{{index-"],*[data-id*="{{index-"]').each(function(){var $thisElement=$(this);var id=$thisElement.prop("id");var dataId=$thisElement.attr("data-id");var dataBlockId=$thisElement.attr("data-block-id");var forProp=$thisElement.prop("for");var rel=$thisElement.attr("rel");var classProp=$thisElement.prop("class");if(id){$thisElement.prop("id",replaceId(id))}if(dataId){$thisElement.attr("data-id",replaceId(dataId))}if(dataBlockId){$thisElement.attr("data-block-id",replaceId(dataBlockId))}if(forProp){$thisElement.prop("for",replaceId(forProp))}if(rel){$thisElement.attr("rel",replaceId(rel))}if(classProp){$thisElement.prop("class",replaceId(classProp))}})}});$(this).find("> fieldset > fieldset.redux-container-serialized_repeater").each(function(index){var $thisRepeater=$(this);if($thisRepeater.prop("id")){$thisRepeater.prop("id",replaceId($thisRepeater.prop("id")))}if($thisRepeater.attr("data-id")){$thisRepeater.attr("data-id",replaceId($thisRepeater.attr("data-id")))}redux.field_objects.serialized_repeater.renumberRows($(this).find("> .redux-serialized-repeater-row-container"))})});if(level===0){fieldSettings.level=[]}}})(jQuery);